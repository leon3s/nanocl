type: namespace
name: simple-forum

networks:
  - name: forum

clusters:
  - name: dev
    auto_start: true
    proxy_config:
      target_port: 3000
      template:
        - test-forum
        - test-stream
    joins:
      - cargo: forum-db
        network: forum
      - cargo: forum
        network: forum
    vars:
      CLUSTER: DEV
      PRE_DOMAIN: dev.

  - name: production
    auto_start: true
    proxy_config:
      target_port: 3000
      template:
        - test-forum
        - test-stream
    joins:
      - cargo: forum-db
        network: forum
      - cargo: forum
        network: forum
    vars:
      CLUSTER: DEV

cargoes:
  - name: forum-db
    image: mariadb:10.5
    domain: "{{networks.forum.gateway}}:{{vars.PRE_DOMAIN}}db.express-forum.com"
    envs:
      - "TZ=Europe/Paris"
      - "MYSQL_ALLOW_EMPTY_PASSWORD=yes"
      - "MYSQL_DATABASE=flarum"
      - "MYSQL_USER=flarum"
      - "MYSQL_PASSWORD=flarum"

  - name: forum
    image: crazymax/flarum:latest
    domain: 192.168.8.100:{{vars.PRE_DOMAIN}}express-forum.com
    envs:
      - "TZ=Europe/Paris"
      - "PUID=1000"
      - "PGID=1000"
      - "DB_HOST={{vars.PRE_DOMAIN}}db.express-forum.com"
      - "DB_NAME=flarum"
      - "DB_USER=flarum"
      - "DB_PASSWORD=flarum"
      - "MEMORY_LIMIT=256M"
      - "UPLOAD_MAX_SIZE=16M"
      - "OPCACHE_MEM_SIZE=128"
      - "REAL_IP_FROM=0.0.0.0/32"
      - "REAL_IP_HEADER=X-Forwarded-For"
      - "LOG_IP_VAR=remote_addr"
      - "FLARUM_DEBUG=false"
      - "FLARUM_BASE_URL=http://{{vars.PRE_DOMAIN}}express-forum.com"
