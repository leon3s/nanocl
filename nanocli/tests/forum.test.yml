type: namespace
name: next-hat-forum

clusters:
  - name: test
    auto_start: true
    joins:
      - cargo: forum-db
        network: next-hat-forum
      - cargo: forum
        network: next-hat-forum
    vars:
      CLUSTER: DEV

networks:
  - name: next-hat-forum

cargoes:
  - name: forum-db
    image: mariadb:10.5
    envs:
      - "TZ=Europe/Paris"
      - "MYSQL_ALLOW_EMPTY_PASSWORD=yes"
      - "MYSQL_DATABASE=flarum"
      - "MYSQL_USER=flarum"
      - "MYSQL_PASSWORD=flarum"
    proxy_config:
      target_port: 3306
      domain_name: "db.express-test.com"
      host_ip: "{{network.gateway}}"
      template: test-stream

  - name: forum
    image: crazymax/flarum:latest
    envs:
      - "TZ=Europe/Paris"
      - "PUID=1000"
      - "PGID=1000"
      - "DB_HOST=db.express-test.com"
      - "DB_NAME=flarum"
      - "DB_USER=flarum"
      - "DB_PASSWORD=flarum"
      - "MEMORY_LIMIT=256M"
      - "UPLOAD_MAX_SIZE=16M"
      - "OPCACHE_MEM_SIZE=128"
      - "REAL_IP_FROM=0.0.0.0/32"
      - "REAL_IP_HEADER=X-Forwarded-For"
      - "LOG_IP_VAR=remote_addr"
      - "FLARUM_DEBUG=false"
      - "FLARUM_BASE_URL=http://forum.express-test.com"
    proxy_config:
      target_port: 8000
      domain_name: "forum.express-test.com"
      host_ip: 192.168.8.100
      template: nodejs-single
